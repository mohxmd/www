---
export const prerender = false;

import type { ComponentProps } from "astro/types";
import type { CollectionEntry } from "astro:content";
import { db, eq, post_view, sql } from "astro:db";

import Number from "#/components/ui/number.astro";

type Props = Omit<ComponentProps<typeof Number>, "value"> & Pick<CollectionEntry<"blog">, "id">;

const { id, ...props } = Astro.props;
const views = await db
  .update(post_view)
  .set({ views: sql`${post_view.views} + 1` })
  .where(eq(post_view.post, id))
  .returning({ views: post_view.views })
  .get()
  .then((res) => res.views ?? 0)
  .catch(() => 0);
---

<Number {...props} value={views}> Views</Number>
